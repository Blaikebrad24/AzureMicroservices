networks:
  app-network:
    driver: bridge

volumes:
  postgres-data:
  redis-data:
  azurite-data:

services:
  # ============================================================
  # INFRASTRUCTURE LAYER
  # ============================================================

  postgres:
    image: postgres:16-alpine
    container_name: postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-appuser}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-apppassword}
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./database/init:/docker-entrypoint-initdb.d
    ports:
      - "5432:5432"
    networks:
      - app-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-appuser}"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: redis
    restart: unless-stopped
    command: redis-server --requirepass ${REDIS_PASSWORD:-redispassword}
    volumes:
      - redis-data:/data
    ports:
      - "6379:6379"
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-redispassword}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  azurite:
    image: mcr.microsoft.com/azure-storage/azurite
    container_name: azurite
    restart: unless-stopped
    command: azurite --blobHost 0.0.0.0 --queueHost 0.0.0.0 --tableHost 0.0.0.0
    volumes:
      - azurite-data:/data
    ports:
      - "10000:10000"
      - "10001:10001"
      - "10002:10002"
    networks:
      - app-network

  # ============================================================
  # IDENTITY LAYER
  # ============================================================

  keycloak:
    build:
      context: ./services/keycloak
      dockerfile: Dockerfile
    container_name: keycloak
    restart: unless-stopped
    environment:
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://postgres:5432/keycloak_db
      KC_DB_USERNAME: ${POSTGRES_USER:-appuser}
      KC_DB_PASSWORD: ${POSTGRES_PASSWORD:-apppassword}
      KC_HOSTNAME: localhost
      KC_HOSTNAME_PORT: 8080
      KC_HTTP_ENABLED: "true"
      KC_HOSTNAME_STRICT_HTTPS: "false"
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN:-admin}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:-admin}
    ports:
      - "8080:8080"
    networks:
      - app-network
    depends_on:
      postgres:
        condition: service_healthy

  # ============================================================
  # AUTH PROXY LAYER
  # ============================================================

  flask-oidc-proxy:
    build:
      context: ./services/flask-oidc-proxy
      dockerfile: Dockerfile
    container_name: flask-oidc-proxy
    restart: unless-stopped
    environment:
      KEYCLOAK_URL: http://keycloak:8080
      KEYCLOAK_PUBLIC_URL: http://localhost:8080
      KEYCLOAK_REALM: app-realm
      CLIENT_ID: nginx-proxy-client
      CLIENT_SECRET: ${OIDC_CLIENT_SECRET:-changeme}
      REDIRECT_URI: https://localhost/auth/callback
      REDIS_URL: redis://:${REDIS_PASSWORD:-redispassword}@redis:6379/0
      SESSION_SECRET: ${SESSION_SECRET:-super-secret-key-change-in-production}
    networks:
      - app-network
    depends_on:
      - keycloak
      - redis

  nginx-proxy:
    build:
      context: ./services/nginx-proxy
      dockerfile: Dockerfile
    container_name: nginx-proxy
    restart: unless-stopped
    ports:
      - "443:443"
      - "80:80"
    volumes:
      - ./services/nginx-proxy/certs:/etc/nginx/certs:ro
    networks:
      - app-network
    depends_on:
      - flask-oidc-proxy
      - frontend

  # ============================================================
  # BACKEND API LAYER
  # ============================================================

  blob-service:
    build:
      context: ./services/blob-service
      dockerfile: Dockerfile
    container_name: blob-service
    restart: unless-stopped
    environment:
      SPRING_PROFILES_ACTIVE: local
      AZURE_STORAGE_CONNECTION_STRING: "DefaultEndpointsProtocol=http;AccountName=devstoreaccount1;AccountKey=Eby8vdM02xNOcqFlqUwJPLlmEtlCDXJ1OUzFT50uSRZ6IFsuFq2UVErCz4I6tq/K1SZFPTOtr/KBHBeksoGMGw==;BlobEndpoint=http://azurite:10000/devstoreaccount1"
      SPRING_DATA_REDIS_HOST: redis
      SPRING_DATA_REDIS_PORT: 6379
      SPRING_DATA_REDIS_PASSWORD: ${REDIS_PASSWORD:-redispassword}
    networks:
      - app-network
    depends_on:
      - azurite
      - redis

  reports-service:
    build:
      context: ./services/reports-service
      dockerfile: Dockerfile
    container_name: reports-service
    restart: unless-stopped
    environment:
      SPRING_PROFILES_ACTIVE: local
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/reports_service_db
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER:-appuser}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:-apppassword}
      SPRING_DATA_REDIS_HOST: redis
      SPRING_DATA_REDIS_PORT: 6379
      SPRING_DATA_REDIS_PASSWORD: ${REDIS_PASSWORD:-redispassword}
    networks:
      - app-network
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

  data-service:
    build:
      context: ./services/data-service
      dockerfile: Dockerfile
    container_name: data-service
    restart: unless-stopped
    environment:
      SPRING_PROFILES_ACTIVE: local
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/data_service_db
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER:-appuser}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:-apppassword}
      SPRING_DATA_REDIS_HOST: redis
      SPRING_DATA_REDIS_PORT: 6379
      SPRING_DATA_REDIS_PASSWORD: ${REDIS_PASSWORD:-redispassword}
    networks:
      - app-network
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

  # ============================================================
  # FRONTEND LAYER
  # ============================================================

  frontend:
    build:
      context: ./services/frontend
      dockerfile: Dockerfile
    container_name: frontend
    restart: unless-stopped
    environment:
      NODE_ENV: production
      BLOB_SERVICE_URL: http://blob-service:8080
      REPORTS_SERVICE_URL: http://reports-service:8080
      DATA_SERVICE_URL: http://data-service:8080
      REDIS_URL: redis://:${REDIS_PASSWORD:-redispassword}@redis:6379/0
    networks:
      - app-network
    depends_on:
      - blob-service
      - reports-service
      - data-service
      - redis
